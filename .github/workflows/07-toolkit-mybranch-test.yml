name: MY own branch Test 

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout toolkit (main)
        uses: actions/checkout@v4
        with:
          repository: chiranjib-swain/toolkit
          ref: hashfiles-outside-test
          path: toolkit
          fetch-depth: 0


      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: toolkit/package-lock.json

      - name: Install root dependencies
        working-directory: toolkit
        run: npm ci

      - name: Lerna bootstrap (link local packages + install per-package deps)
        working-directory: toolkit
        run: npx lerna bootstrap --ci

      - name: Build
        working-directory: toolkit
        run: npm run build

      - name: Test (Jest from root, glob only)
        working-directory: toolkit
        run: npx jest packages/glob --runInBand

      - name: Functional check exclude **/node_modules/** (scoped + deterministic)
        working-directory: toolkit
        shell: bash
        run: |
          set -euo pipefail

          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "GITHUB_ACTION_PATH=${GITHUB_ACTION_PATH:-"(not set)"}"

          if [[ -z "${GITHUB_ACTION_PATH:-}" ]]; then
            export GITHUB_ACTION_PATH="$RUNNER_TEMP/fake-action-path"
          fi

          TEST_DIR_WS="$GITHUB_WORKSPACE/hashfiles-exclude-nm"
          TEST_DIR_AP="$GITHUB_ACTION_PATH/hashfiles-exclude-nm"

          rm -rf "$TEST_DIR_WS" "$TEST_DIR_AP"
          mkdir -p "$TEST_DIR_WS/node_modules/pkg" "$TEST_DIR_WS/src" "$TEST_DIR_AP/node_modules/pkg"

          echo '{"where":"workspace-src"}' > "$TEST_DIR_WS/src/included.json"
          echo '{"where":"workspace-node_modules"}' > "$TEST_DIR_WS/node_modules/pkg/excluded.json"
          echo '{"where":"action-node_modules"}' > "$TEST_DIR_AP/node_modules/pkg/excluded-action.json"

          echo "Workspace tree:"
          find "$TEST_DIR_WS" -type f -print | sort
          echo "Action path tree:"
          find "$TEST_DIR_AP" -type f -print | sort

          cat > ./check-exclude-node-modules.mjs <<'EOF_NODE'
          import { writeFileSync } from 'fs';
          const glob = await import('./packages/glob/lib/glob.js');

          const ws = process.env.GITHUB_WORKSPACE;
          const ap = process.env.GITHUB_ACTION_PATH;

          // Scope patterns to our test dir to avoid hashing the whole repository.
          const patterns = [
            `${ws}/hashfiles-exclude-nm/**/*.json`,
            `${ap}/hashfiles-exclude-nm/**/*.json`
          ].join('\n');

          // Keep the same *options structure* you requested (exclude contains **/node_modules/**)
          const opts = {
            roots: [ws, ap],
            allowFilesOutsideWorkspace: true,
            exclude: ['**/node_modules/**']
          };

          const h1 = await glob.hashFiles(patterns, '', opts);
          console.log('h1:', JSON.stringify(h1));

          // Mutate a JSON file under node_modules; if exclude works as a real glob, hash should NOT change.
          const nmFile = `${ws}/hashfiles-exclude-nm/node_modules/pkg/excluded.json`;
          writeFileSync(nmFile, '{"where":"workspace-node_modules","v":2}\n');

          const h2 = await glob.hashFiles(patterns, '', opts);
          console.log('h2:', JSON.stringify(h2));

          if (h1 !== h2) {
            throw new Error(
              "Hash changed after modifying a node_modules JSON file; exclude:['**/node_modules/**'] did not exclude it (or exclude doesn't support full globs)."
            );
          }

          console.log("OK: exclude:['**/node_modules/**'] prevented node_modules changes from affecting the hash.");
          EOF_NODE

          node ./check-exclude-node-modules.mjs
