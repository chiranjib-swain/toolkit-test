name: In Resolved Roots

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout toolkit (main)
        uses: actions/checkout@v4
        with:
          repository: priyagupta108/toolkit
          ref: hashFiles-extended-options
          path: toolkit
          fetch-depth: 0


      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: toolkit/package-lock.json

      - name: Install root dependencies
        working-directory: toolkit
        run: npm ci

      - name: Lerna bootstrap (link local packages + install per-package deps)
        working-directory: toolkit
        run: npx lerna bootstrap --ci

      - name: Build
        working-directory: toolkit
        run: npm run build

      - name: Test (Jest from root, glob only)
        working-directory: toolkit
        run: npx jest packages/glob --runInBand

      - name: Functional check- isInResolvedRoots edge case (resolvedFile === root)
        working-directory: toolkit
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "$RUNNER_TEMP/hashfiles-root-eq"
          echo "ROOTFILE" > "$RUNNER_TEMP/hashfiles-root-eq/rootfile.txt"

          echo "RUNNER_TEMP=$RUNNER_TEMP"
          ls -la "$RUNNER_TEMP/hashfiles-root-eq"

          cat > ./check-root-eq.mjs <<'EOF'
          const glob = await import('./packages/glob/lib/glob.js');

          const root = process.env.RUNNER_TEMP + '/hashfiles-root-eq';
          const fileAtRoot = root + '/rootfile.txt';

          // Pattern is the exact file path; root is the directory that contains it.
          // If isInResolvedRoots is implemented incorrectly, this may incorrectly treat the file as outside roots.
          console.log('root:', root);
          console.log('fileAtRoot:', fileAtRoot);

          const patterns = fileAtRoot;

          let hash;
          try {
            hash = await glob.hashFiles(patterns, '', { roots: [root] });
            console.log('hash:', JSON.stringify(hash));
          } catch (e) {
            console.log('threw:', (e && e.message) ? e.message : String(e));
            throw e;
          }

          if (!hash || hash.length === 0) {
            throw new Error('Expected a non-empty hash for a file inside the root directory.');
          }
          EOF

          node ./check-root-eq.mjs
