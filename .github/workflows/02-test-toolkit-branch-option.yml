name: Test toolkit branch (allowOutsideWorkspace)

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout toolkit branch
        uses: actions/checkout@v4
        with:
          repository: chiranjib-swain/toolkit
          ref: copilot/add-opt-in-flag-hashfiles
          path: toolkit
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: toolkit/package-lock.json

      - name: Install root dependencies
        working-directory: toolkit
        run: npm ci

      - name: Lerna bootstrap (link local packages + install per-package deps)
        working-directory: toolkit
        run: npx lerna bootstrap --ci

      - name: Debug- check http-client dependency installation
        working-directory: toolkit
        shell: bash
        run: |
          set -euo pipefail
          echo "=== toolkit root ==="
          ls -la

          echo "=== packages/http-client ==="
          ls -la packages/http-client || true

          echo "=== packages/http-client/node_modules (if present) ==="
          ls -la packages/http-client/node_modules || true

          echo "=== check undici/tunnel folders (if present) ==="
          ls -la packages/http-client/node_modules/undici || true
          ls -la packages/http-client/node_modules/tunnel || true

          echo "=== packages/http-client/package.json (top part) ==="
          cat packages/http-client/package.json | sed -n '1,180p'

      - name: Verify key deps resolve (from http-client package dir)
        working-directory: toolkit
        shell: bash
        run: |
          set -euo pipefail
          node -e "require.resolve('undici', {paths: ['toolkit/packages/http-client']}); console.log('undici ok (http-client)')"
          node -e "require.resolve('tunnel',  {paths: ['toolkit/packages/http-client']}); console.log('tunnel ok (http-client)')"

      - name: Build
        working-directory: toolkit
        run: npm run build

      - name: Run unit tests
        working-directory: toolkit
        run: npm test

      - name: Functional check @actions/glob hashFiles outside workspace (default vs opt-in)
        working-directory: toolkit
        shell: bash
        run: |
          set -euo pipefail
          echo "outside" > "$RUNNER_TEMP/outside-ws.txt"
          echo "Created: $RUNNER_TEMP/outside-ws.txt"
          ls -la "$RUNNER_TEMP/outside-ws.txt"

          cat > /tmp/check-hash.mjs <<'EOF'
          import * as glob from '@actions/glob';

          const outsidePath = process.env.RUNNER_TEMP + '/outside-ws.txt';

          // Default behavior: should ignore outside-workspace paths
          const hDefault = await glob.hashFiles(outsidePath);
          console.log('default hash:', JSON.stringify(hDefault));

          // Opt-in behavior: should hash outside-workspace paths
          const hOptIn = await glob.hashFiles(outsidePath, { allowOutsideWorkspace: true });
          console.log('opt-in hash:', JSON.stringify(hOptIn));

          if (hDefault && hDefault.length > 0) {
            throw new Error('Expected default hash to be empty when hashing outside workspace.');
          }
          if (!hOptIn || hOptIn.length === 0) {
            throw new Error('Expected opt-in hash to be non-empty when allowOutsideWorkspace is true.');
          }
          EOF

          node /tmp/check-hash.mjs
